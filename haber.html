<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Haber Detay覺</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<h1 id="title"></h1>
<img id="image" style="max-width:600px;">
<p id="content"></p>
<p><strong>Okunma:</strong> <span id="views"></span></p>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, updateDoc, increment }
from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDL5f3Hv_H1fXLM25W8z-OW_AclIJEW7Ho",
  authDomain: "bartin-duysun.firebaseapp.com",
  projectId: "bartin-duysun",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const params = new URLSearchParams(window.location.search);
const slug = params.get("slug");

if (!slug) {
  document.body.innerHTML = "<h2>Haber bulunamad覺</h2>";
  throw new Error("Slug yok");
}

async function loadNews() {

  const q = query(collection(db,"haberler"), where("slug","==",slug));
  const snapshot = await getDocs(q);

  if (snapshot.empty) {
    document.body.innerHTML = "<h2>Haber bulunamad覺</h2>";
    return;
  }

  const docSnap = snapshot.docs[0];
  const data = docSnap.data();

  document.title = data.title + " | Bart覺n Duysun";

  document.getElementById("title").innerText = data.title;
  document.getElementById("image").src = data.image;
  document.getElementById("content").innerHTML = data.content;

  let currentViews = data.views || 0;
  const viewed = localStorage.getItem("viewed_" + slug);

  if (!viewed) {
    await updateDoc(docSnap.ref, {
      views: increment(1)
    });
    localStorage.setItem("viewed_" + slug, "true");
    currentViews += 1;
  }

  document.getElementById("views").innerText = currentViews;

  const cleanText = data.content.replace(/<[^>]*>?/gm, '');

  // META DESCRIPTION
  const meta = document.createElement("meta");
  meta.name = "description";
  meta.content = cleanText.substring(0, 160);
  document.head.appendChild(meta);

  // CANONICAL
  const canonical = document.createElement("link");
  canonical.rel = "canonical";
  canonical.href = "https://www.bartinduysun.com/haber.html?slug=" + slug;
  document.head.appendChild(canonical);

  // OPEN GRAPH
  const ogTitle = document.createElement("meta");
  ogTitle.setAttribute("property", "og:title");
  ogTitle.content = data.title;
  document.head.appendChild(ogTitle);

  const ogDesc = document.createElement("meta");
  ogDesc.setAttribute("property", "og:description");
  ogDesc.content = cleanText.substring(0,160);
  document.head.appendChild(ogDesc);

  const ogImage = document.createElement("meta");
  ogImage.setAttribute("property", "og:image");
  ogImage.content = data.image;
  document.head.appendChild(ogImage);

  const ogUrl = document.createElement("meta");
  ogUrl.setAttribute("property", "og:url");
  ogUrl.content = "https://www.bartinduysun.com/haber.html?slug=" + slug;
  document.head.appendChild(ogUrl);

  const ogType = document.createElement("meta");
  ogType.setAttribute("property", "og:type");
  ogType.content = "article";
  document.head.appendChild(ogType);
}

loadNews();

</script>
</body>
</html>

